<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparison Game - Admin</title>
    <!-- Add the Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        /* (Keep all the same CSS styles from previous admin interface) */
    </style>
</head>
<body>
    <h1>Comparison Game - Admin Panel</h1>
    
    <div class="section">
        <h2>Player Registration</h2>
        <div id="registered-players">
            <p>Waiting for players to register...</p>
            <table id="players-table">
                <thead>
                    <tr>
                        <th>Player Name</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="players-list">
                    <!-- Player list will be populated here -->
                </tbody>
            </table>
        </div>
        <button id="start-game-btn" disabled>Start Game</button>
        <p id="min-players-warning">At least 2 players needed to start (4 recommended)</p>
    </div>
    
    <div class="section" id="choices-section" style="display: none;">
        <h2>Player Choices (Round <span id="current-round">1</span>/3)</h2>
        <div id="choices-container">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Choice</th>
                    </tr>
                </thead>
                <tbody id="choices-list">
                    <!-- Choices will be populated here -->
                </tbody>
            </table>
        </div>
        <button id="start-round-btn" disabled>Start Round</button>
        <p>Waiting for all players to make their choices...</p>
    </div>
    
    <div class="section" id="dice-section" style="display: none;">
        <h2>Dice Input</h2>
        <div id="dice-input-container">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Dice 1</th>
                        <th>Dice 2</th>
                        <th>Dice 3</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="dice-list">
                    <!-- Dice inputs will be populated here -->
                </tbody>
            </table>
        </div>
        <button id="calculate-results-btn" disabled>Calculate Results</button>
    </div>
    
    <div class="section" id="results-section" style="display: none;">
        <h2>Round Results (Round <span id="results-round">1</span>/3)</h2>
        <div id="results-container">
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Total</th>
                        <th>Points Earned</th>
                        <th>Prediction Bonus</th>
                    </tr>
                </thead>
                <tbody id="results-list">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
        </div>
        <button id="next-round-btn">Next Round</button>
        <button id="end-game-btn">End Game</button>
    </div>

    <div class="section" id="final-results-section" style="display: none;">
        <h2>Final Game Results</h2>
        <div id="final-results-container">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Total Points</th>
                        <th>Final Bonus</th>
                        <th>Grand Total</th>
                    </tr>
                </thead>
                <tbody id="final-results-list">
                    <!-- Final results will be populated here -->
                </tbody>
            </table>
        </div>
        <button id="new-game-btn">Start New Game</button>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCd2B_XrFV07tWrKwSzwaOpzW84yygVhjo",
            authDomain: "comparison-650b2.firebaseapp.com",
            databaseURL: "https://comparison-650b2-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "comparison-650b2",
            storageBucket: "comparison-650b2.appspot.com",
            messagingSenderId: "389030420315",
            appId: "1:389030420315:web:53c390a2fe93156f56047e",
            measurementId: "G-N0EBD0YSJ0"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // Database references
        const gameRef = db.ref('games/comparison');
        const playersRef = gameRef.child('players');
        const choicesRef = gameRef.child('choices');
        const diceRef = gameRef.child('dice');
        const resultsRef = gameRef.child('results');
        const roundsRef = gameRef.child('rounds');
        const gameStateRef = gameRef.child('state');
        
        // Game state
        let currentRound = 1;
        const maxRounds = 3;
        let players = {};
        let choices = {};
        let diceResults = {};
        let roundResults = {};
        let gameActive = false;
        
        // DOM elements
        const playersList = document.getElementById('players-list');
        const startGameBtn = document.getElementById('start-game-btn');
        const choicesList = document.getElementById('choices-list');
        const startRoundBtn = document.getElementById('start-round-btn');
        const diceList = document.getElementById('dice-list');
        const calculateResultsBtn = document.getElementById('calculate-results-btn');
        const resultsList = document.getElementById('results-list');
        const minPlayersWarning = document.getElementById('min-players-warning');
        const currentRoundDisplay = document.getElementById('current-round');
        const resultsRoundDisplay = document.getElementById('results-round');
        const finalResultsList = document.getElementById('final-results-list');
        
        // Sections
        const choicesSection = document.getElementById('choices-section');
        const diceSection = document.getElementById('dice-section');
        const resultsSection = document.getElementById('results-section');
        const finalResultsSection = document.getElementById('final-results-section');
        
        // Listen for player registrations
        playersRef.on('value', (snapshot) => {
            players = snapshot.val() || {};
            updatePlayersList();
            
            // Enable start game button if enough players
            if (Object.keys(players).length >= 2) {
                startGameBtn.disabled = false;
                minPlayersWarning.style.color = 'green';
                minPlayersWarning.textContent = `Ready to start with ${Object.keys(players).length} players!`;
            } else {
                startGameBtn.disabled = true;
                minPlayersWarning.style.color = 'red';
                minPlayersWarning.textContent = `At least 2 players needed to start (4 recommended)`;
            }
        });
        
        // Listen for player choices
        choicesRef.on('value', (snapshot) => {
            choices = snapshot.val() || {};
            updateChoicesList();
            
            // Check if all players have chosen
            if (gameActive && Object.keys(choices).length === Object.keys(players).length) {
                startRoundBtn.disabled = false;
            }
        });
        
        // Listen for dice submissions
        diceRef.on('value', (snapshot) => {
            diceResults = snapshot.val() || {};
            
            // Check if all players have submitted dice
            if (gameActive && Object.keys(diceResults).length === Object.keys(players).length) {
                calculateResultsBtn.disabled = false;
            }
        });
        
        // Update players list display
        function updatePlayersList() {
            playersList.innerHTML = '';
            for (const [id, player] of Object.entries(players)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td>Registered</td>
                `;
                playersList.appendChild(row);
            }
        }
        
        // Update choices list display
        function updateChoicesList() {
            choicesList.innerHTML = '';
            for (const [playerId, choice] of Object.entries(choices)) {
                const playerName = players[playerId]?.name || playerId;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${playerName}</td>
                    <td><span class="player-choice ${choice}">${choice.toUpperCase()}</span></td>
                `;
                choicesList.appendChild(row);
            }
        }
        
        // Start the game
        startGameBtn.addEventListener('click', () => {
            gameActive = true;
            startGameBtn.disabled = true;
            choicesSection.style.display = 'block';
            currentRoundDisplay.textContent = currentRound;
            
            // Set game state to "choosing"
            gameStateRef.set({
                status: 'choosing',
                round: currentRound
            });
            
            // Clear previous choices and dice results
            choicesRef.remove();
            diceRef.remove();
        });
        
        // Start the round (dice input)
        startRoundBtn.addEventListener('click', () => {
            choicesSection.style.display = 'none';
            diceSection.style.display = 'block';
            startRoundBtn.disabled = true;
            
            // Set game state to "rolling"
            gameStateRef.set({
                status: 'rolling',
                round: currentRound
            });
            
            setupDiceInputs();
        });
        
        // Set up dice inputs
        function setupDiceInputs() {
            diceList.innerHTML = '';
            
            for (const [playerId, player] of Object.entries(players)) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td><input type="number" min="1" max="6" class="dice-1" data-player="${playerId}"></td>
                    <td><input type="number" min="1" max="6" class="dice-2" data-player="${playerId}"></td>
                    <td><input type="number" min="1" max="6" class="dice-3" data-player="${playerId}"></td>
                    <td class="total" id="total-${playerId}">0</td>
                    <td><button class="confirm-dice" data-player="${playerId}">Confirm</button></td>
                `;
                diceList.appendChild(row);
                
                // Add event listeners to dice inputs
                const dice1 = row.querySelector('.dice-1');
                const dice2 = row.querySelector('.dice-2');
                const dice3 = row.querySelector('.dice-3');
                const confirmBtn = row.querySelector('.confirm-dice');
                const totalCell = row.querySelector('.total');
                
                // Calculate total when any dice changes
                [dice1, dice2, dice3].forEach(dice => {
                    dice.addEventListener('change', () => {
                        const total = parseInt(dice1.value || 0) + parseInt(dice2.value || 0) + parseInt(dice3.value || 0);
                        totalCell.textContent = total;
                    });
                });
                
                // Confirm dice values
                confirmBtn.addEventListener('click', () => {
                    const dice1Val = parseInt(dice1.value);
                    const dice2Val = parseInt(dice2.value);
                    const dice3Val = parseInt(dice3.value);
                    
                    if (isNaN(dice1Val) || dice1Val < 1 || dice1Val > 6) {
                        alert('Please enter a valid number (1-6) for Dice 1');
                        return;
                    }
                    if (isNaN(dice2Val) || dice2Val < 1 || dice2Val > 6) {
                        alert('Please enter a valid number (1-6) for Dice 2');
                        return;
                    }
                    if (isNaN(dice3Val) || dice3Val < 1 || dice3Val > 6) {
                        alert('Please enter a valid number (1-6) for Dice 3');
                        return;
                    }
                    
                    const total = dice1Val + dice2Val + dice3Val;
                    
                    // Save dice results to Firebase
                    diceRef.child(playerId).set({
                        dice: [dice1Val, dice2Val, dice3Val],
                        total: total
                    });
                    
                    // Disable inputs for this player
                    dice1.disabled = true;
                    dice2.disabled = true;
                    dice3.disabled = true;
                    confirmBtn.disabled = true;
                });
            });
        }
        
        // Calculate results
        calculateResultsBtn.addEventListener('click', () => {
            diceSection.style.display = 'none';
            resultsSection.style.display = 'block';
            resultsRoundDisplay.textContent = currentRound;
            calculateResultsBtn.disabled = true;
            
            calculateResults();
        });
        
        // Calculate and display results
        function calculateResults() {
            // Create array of players with their totals and choices
            const playerData = [];
            
            for (const [playerId, player] of Object.entries(players)) {
                playerData.push({
                    id: playerId,
                    name: player.name,
                    total: diceResults[playerId]?.total || 0,
                    choice: choices[playerId] || 'none'
                });
            }
            
            // Sort by total (descending)
            playerData.sort((a, b) => b.total - a.total);
            
            // Assign ranks (handling ties)
            let currentRank = 1;
            for (let i = 0; i < playerData.length; i++) {
                if (i > 0 && playerData[i].total === playerData[i - 1].total) {
                    playerData[i].rank = playerData[i - 1].rank;
                } else {
                    playerData[i].rank = currentRank;
                }
                currentRank++;
            }
            
            // Calculate points based on ranks
            const rankGroups = {};
            playerData.forEach(player => {
                if (!rankGroups[player.rank]) {
                    rankGroups[player.rank] = [];
                }
                rankGroups[player.rank].push(player);
            });
            
            // Assign points based on rank groups
            const pointsMap = {
                1: 6,  // 1st place
                2: 3,  // 2nd place
                3: 1,  // 3rd place
                4: 0   // 4th place
            };
            
            Object.keys(rankGroups).forEach(rank => {
                const playersInRank = rankGroups[rank];
                const rankNum = parseInt(rank);
                
                // Calculate total points for this rank group
                let totalPoints = 0;
                let pointPositions = [];
                
                for (let i = 0; i < playersInRank.length; i++) {
                    const position = rankNum + i;
                    if (pointsMap[position] !== undefined) {
                        totalPoints += pointsMap[position];
                        pointPositions.push(position);
                    }
                }
                
                // Distribute points evenly among tied players
                const pointsPerPlayer = totalPoints / playersInRank.length;
                
                playersInRank.forEach(player => {
                    // Check for prediction bonuses
                    let bonus = 0;
                    let bonusReason = '';
                    
                    if (player.choice === 'max' && player.rank === 1) {
                        bonus = pointsPerPlayer; // Double points
                        bonusReason = 'Correct MAX prediction';
                    } else if (player.choice === 'min' && player.rank === playerData.length) {
                        bonus = pointsPerPlayer; // Double points
                        bonusReason = 'Correct MIN prediction';
                    } else if (player.choice === 'mid') {
                        // Check if player is in the middle (not first or last)
                        if (player.rank > 1 && player.rank < playerData.length) {
                            bonus = pointsPerPlayer; // Double points
                            bonusReason = 'Correct MID prediction';
                        }
                    } else if (player.choice === 'zero' && pointsPerPlayer === 0) {
                        bonus = 45; // Special zero bonus
                        bonusReason = 'ZERO bonus';
                    }
                    
                    player.points = pointsPerPlayer;
                    player.bonus = bonus;
                    player.bonusReason = bonusReason;
                    player.totalPoints = pointsPerPlayer + bonus;
                    player.pointPositions = pointPositions.join(', ');
                });
            });
            
            // Save round results to Firebase
            const roundResults = {};
            playerData.forEach(player => {
                roundResults[player.id] = {
                    name: player.name,
                    rank: player.rank,
                    total: player.total,
                    points: player.points,
                    bonus: player.bonus,
                    totalPoints: player.totalPoints,
                    choice: player.choice,
                    bonusReason: player.bonusReason
                };
            });
            
            roundsRef.child(`round${currentRound}`).set(roundResults);
            
            // Display results
            resultsList.innerHTML = '';
            playerData.forEach(player => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player.rank}</td>
                    <td>${player.name} (${player.choice})</td>
                    <td>${player.total}</td>
                    <td>${player.points.toFixed(1)}</td>
                    <td>${player.bonus > 0 ? `${player.bonus} (${player.bonusReason})` : 'None'}</td>
                `;
                resultsList.appendChild(row);
            });
            
            // Set game state to "results"
            gameStateRef.set({
                status: 'results',
                round: currentRound
            });
        }
        
        // Next round button
        document.getElementById('next-round-btn').addEventListener('click', () => {
            currentRound++;
            
            if (currentRound <= maxRounds) {
                // Prepare for next round
                resultsSection.style.display = 'none';
                choicesSection.style.display = 'block';
                currentRoundDisplay.textContent = currentRound;
                
                // Clear previous choices and dice results
                choicesRef.remove();
                diceRef.remove();
                
                // Set game state to "choosing"
                gameStateRef.set({
                    status: 'choosing',
                    round: currentRound
                });
            } else {
                // Game is over, show final results
                showFinalResults();
            }
        });
        
        // Show final results after all rounds
        function showFinalResults() {
            resultsSection.style.display = 'none';
            finalResultsSection.style.display = 'block';
            
            // Calculate total points across all rounds
            roundsRef.once('value').then(snapshot => {
                const allRounds = snapshot.val() || {};
                const playerTotals = {};
                
                // Sum points across all rounds for each player
                for (const [roundKey, round] of Object.entries(allRounds)) {
                    for (const [playerId, player] of Object.entries(round)) {
                        if (!playerTotals[playerId]) {
                            playerTotals[playerId] = {
                                name: player.name,
                                totalPoints: 0,
                                totalBonus: 0
                            };
                        }
                        playerTotals[playerId].totalPoints += player.points;
                        playerTotals[playerId].totalBonus += player.bonus;
                    }
                }
                
                // Display final results
                finalResultsList.innerHTML = '';
                for (const [playerId, player] of Object.entries(playerTotals)) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${player.name}</td>
                        <td>${player.totalPoints.toFixed(1)}</td>
                        <td>${player.totalBonus.toFixed(1)}</td>
                        <td><strong>${(player.totalPoints + player.totalBonus).toFixed(1)}</strong></td>
                    `;
                    finalResultsList.appendChild(row);
                }
                
                // Set game state to "finished"
                gameStateRef.set({
                    status: 'finished',
                    round: 'final'
                });
            });
        }
        
        // End game button
        document.getElementById('end-game-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to end the game early?')) {
                showFinalResults();
            }
        });
        
        // New game button
        document.getElementById('new-game-btn').addEventListener('click', () => {
            if (confirm('Start a new game? All current data will be reset.')) {
                // Reset game state
                currentRound = 1;
                gameActive = false;
                
                // Clear all game data
                gameRef.remove();
                
                // Hide all sections except registration
                choicesSection.style.display = 'none';
                diceSection.style.display = 'none';
                resultsSection.style.display = 'none';
                finalResultsSection.style.display = 'none';
                
                // Reset buttons
                startGameBtn.disabled = true;
                startRoundBtn.disabled = true;
                calculateResultsBtn.disabled = true;
                
                // Reset displays
                currentRoundDisplay.textContent = currentRound;
                resultsRoundDisplay.textContent = currentRound;
                minPlayersWarning.style.color = 'red';
                minPlayersWarning.textContent = 'At least 2 players needed to start (4 recommended)';
            }
        });
    </script>
</body>
</html>
